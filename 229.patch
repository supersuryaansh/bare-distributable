From 90c598f2f6ff597baa37d978ee9749b3041f613c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Kasper=20Isager=20Dalsgar=C3=B0?= <kasperisager@hey.com>
Date: Sat, 23 Aug 2025 13:22:50 +0200
Subject: [PATCH] Split out `libsodium` extensions into separate target

---
 CMakeLists.txt | 25 ++++++++++++++++++-------
 1 file changed, 18 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index b6611d03..57a4e98a 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -208,18 +208,31 @@ if(target MATCHES "linux|android")
   )
 endif()
 
-add_bare_module(sodium_native_bare)
+add_library(sodium_extensions OBJECT)
 
 target_sources(
-  ${sodium_native_bare}
+  sodium_extensions
   PRIVATE
-    binding.cc
     extensions/tweak/tweak.c
     extensions/tweak/tweak.h
     extensions/pbkdf2/pbkdf2.c
     extensions/pbkdf2/pbkdf2.h
 )
 
+target_link_libraries(
+  sodium_extensions
+  PUBLIC
+    sodium
+)
+
+add_bare_module(sodium_native_bare)
+
+target_sources(
+  ${sodium_native_bare}
+  PRIVATE
+    binding.cc
+)
+
 target_link_libraries(
   ${sodium_native_bare}
   PRIVATE
@@ -227,6 +240,7 @@ target_link_libraries(
     jstl
   PUBLIC
     sodium
+    sodium_extensions
 )
 
 add_napi_module(sodium_native_node)
@@ -235,10 +249,6 @@ target_sources(
   ${sodium_native_node}
   PRIVATE
     binding.cc
-    extensions/tweak/tweak.c
-    extensions/tweak/tweak.h
-    extensions/pbkdf2/pbkdf2.c
-    extensions/pbkdf2/pbkdf2.h
 )
 
 target_compile_definitions(
@@ -254,6 +264,7 @@ target_link_libraries(
     jstl
   PUBLIC
     sodium
+    sodium_extensions
 )
 
 resolve_node_module(bare-compat-napi compat)
